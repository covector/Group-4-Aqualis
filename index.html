<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="description" content="Demonstrating neuroevolution via a game of dodging lasers">
    <meta property="og:site_name" content="NeuroEvolution">
    <meta property="og:title" content="NeuroEvolution" />
    <meta property="og:description" content="Demonstrating neuroevolution via a game of dodging lasers" />
    <meta property="og:image" itemprop="image" content="https://covector.github.io/Group-4-Aqualis/images/thumbnail.png">
    <meta property="og:type" content="website" />
    <title>Group 4 Project Aqualis</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    <script>
      var unityInstance = UnityLoader.instantiate("unityContainer", "Build/grp 4 test.json", {onProgress: UnityProgress});
    </script>
    <script src="anim.js"></script>
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="stylesheet" href="looks.css">
  </head>
  <body>
    <div class="topBar">
      <div class="load">Loading...</div><div class="ne">NeuroEvolution</div>
    </div>
    <div class="topImage"></div>
    <div class="title"><span class="titleBig">NeuroEvolution </span><span class="titleSmall">a demonstration of reinforcement learning</span></div>
  <div class="game">
    <div class="webgl-content">
      <div id="unityContainer" style="width: 70vw; height: 39.375vw; margin: auto;"></div>
      <div class="footer">
        <img src="images/control.png" alt="control is arrow keys" class="control"/>
        <div class="fullscreen" onclick="unityInstance.SetFullscreen(1)"></div>
      </div>
    </div>
    <p style="margin-bottom: 0;">
      This is a game of dodging lasers, the only objective of the game is to survive as long as possible, there are 2 bots in the game too, both of them have been trained using neuroevolution.
    </p>
  </div>
    <div class="middleBar">
      Explanation
    </div>
    <div class="content">
    <h1 style="margin-top: 30px;">What is NeuroEvolution</h1>
    <p>
      You can split the term into 2 parts, "Neuro" and "Evolution". Let's look at each of these words individually.
    </p>

    <h2>"Neuro"</h2>
    <p>
      "Neuro" refers to neural network.
    </p>
    <p>
      Neural network is a mathematical function, which takes a list of numbers(vector) as inputs, then outputs another list of numbers(vector).
    </p>
    <div class="centerAlign"><img src="images/neuralNet.png" alt="a standard neural network" class="nn space"/></div>
    <p>
      Neural network is a function that have coefficient or parameters, which you can change in order to achieve a different result.
      \[neural\_network(x)=\sigma (w_2 \sigma (w_1 x + b_1 ) +b_2)=y\]
    </p>
    <p>
      Just like for quadratic function, where a, b and c are parameters which you can change to achieve a different result.
      \[quadratic(x)=ax^2+bx+c=y\]
    </p>

    <div class="centerAlign"><img src="images/quadratic.gif" alt="tweaking quadratic coefficient in desmos" class="quadratic space frame"/></div>
    <p>
      In this game, the neural network takes information from the environment as input, then outputs the direction the bot decided to go. This is equivalent to how our brain takes sensory stimuli as inputs, then outputs some decision. So neural network is somewhat the brain of the bot.
    </p>
    <div class="centerAlign"><img src="images/botBrain.png" alt="neural network is the brain of the bot" class="brain space"/></div>
    <p>
      But how should you choose the parameters for the neural network in order to be able to dodge lasers? This is where the "Evolution" part comes into play.
    </p>
 

    <h2>"Evolution"</h2>
    <p>
      "Evolution" refers to genetic algorithm.
    </p>
    <p> 
        Genetic algorithm is an algorithm based on the theory of natural selection, which means that only the fittest organism can survive, only the organism with desirable features can pass down these features to their offspring, which explains how organism evolve.
    </p>
    <div class="centerAlign"><img src="images/evolution.jpeg" alt="evolution of human" class="evolve space frame"/></div>
    <h5>
      Before we talk about the algorithm, let's first define some of the terms:
    </h5>
    <h6><strong>Generation</strong> - generation corresponds to 1 population. A generation starts when a new popoulation is initialized, and it ends when the next population is initialized</h6>
    <h6><strong>Brain</strong> - from now on I am going to use brain and neural network interchangeably</h6>
    <h6><strong>Population</strong> - A bunch of bots that are spawned in at the same time. A population is all the bots that are from the same generation</h6>
    <br />
    <h2>There are 5 basic steps in genetic algorithm:</h2>
    <h3>1. Initilization</h3>
    <p>
      Start a new generation, initialize a population. A bunch of bots are create, where each of them has a neural network acting as their brain
    </p>
    <div class="centerAlign"><img src="images/initialization.png" alt="initilization stage" class="step1 space frame" /></div>
    <h3>2. Selection</h3>
    <p>
      Select the fittest. The bots are forced to play the laser game, where all the bots with a weak neural network will touch the lasers and die, only the bots with the best neural network can survive
    </p>
    <div class="centerAlign"><img src="images/selection.png" alt="selection stage" class="step2 space frame" /></div>
    <h3>3. Crossover</h3>
    <p>
      Create a whole new population based on the fittest bots from the previous population. A new population of bots are initialized, and their brain are copied from the 5 bots that survived the longest
    </p>
    <div class="centerAlign"><img src="images/crossover.png" alt="crossover stage" class="step3 space" /></div>
    <h3>4. Mutation</h3>
    <p>
      The gene of the new bots are mutated. In the game above, some of the parameters of the neural network is being selected, and each of the selected parameters will be added with a randomly generated number. This stage allows the brain to improve
    </p>
    <div class="centerAlign"><img src="images/mutation.png" alt="mutation stage" class="step4 space" /></div>
    <h3>5. Repeat</h3>
    <p>
      End current generation and start a new generation, then repeat step 2-4 with the newly created population. (The gif below has been sped up 5x)
    </p>
    <div class="centerAlign"><img src="images/train.gif" alt="the training process" class="train space frame" /></div>
    <h2>Conclusion</h2>
    <p>
      In a nutshell, neuroevolution means that you are trying to find a neural network that outputs the best decision in the laser game, and in order to find a good neural network, you keep eliminating bad neural networks while mutating the good ones slightly in order to get an improvement.
    </p>

    <h1>Architecture and Parameters</h1>
    <p>
      This section is for people who are familiar with neural network already. Also some of the information has been ommited in this section, more detailed and accurate information can be found in the "Mathematical Details of the Architecture" section.
    </p>
    <h2>Architecture</h2>
    <div class="centerAlign"><img src="images/architecture.png" alt="the architecture used" class="architecture space" /></div>
    <h6>- Layer: 3</h6>
    <h6>- Input Layer Size: 17 units</h6>
    <h6>- Hidden Layer Size: 5 units</h6>
    <h6>- Output Layer Size: 4 units</h6>
    <h3>Input Layer</h3>
    <p><strong>12</strong> of the input units are ray detection (1 for each ray): each units represent the distance of the bot from the laser</p>
    <div class="centerAlign"><img src="images/inputLaserDetection.png" alt="laser detection as inputs" class="input1 space frame" /></div>
    <p><strong>4</strong> of the input units are x position, y position, x velocity and y velocity</p>
    <div class="centerAlign"><img src="images/inputAgent.png" alt="mechanical information of bot as inputs" class="input2 space frame" /></div>
    <p><strong>1</strong> of the input units is the center detection: the unit will be 1 when bot is in a laser, else it will be 0</p>
    <div class="centerAlign"><img src="images/inputCenter.png" alt="center detection as input" class="input3 space frame" /></div>
    <p>
      Also each laser has an urgency value, where it is initially 0 when spawning the laser, then it increases until the spawn animation has ended, the value will stop at 1
    </p>
    <p>
      This urgency value is used for determining how urgent it is to dodge a particular laser
    </p>
    <p>
      All the ray detection inputs are multiplied by the urgency of the laser that it detected
    </p>
    <div class="centerAlign"><img src="images/urgency.gif" alt="urgency of a laser" class="urgent space frame" /></div>
    <h3>Output Layer</h3>
    <p>
      Each of the output units corresponds to one of the arrow keys. So the neural network is controlling the bot just like how you control your player in the game.
    </p>
    <div class="centerAlign"><img src="images/output.png" alt="keystrokes as output" class="output space frame" /></div>
    <h2>Parameters</h2>
    <h6>- Population Size per generation: 60</h6>
    <h6>- Mutation Rate: 0.1 and 0.2 (the mutation rate of the two bots are different)</h6>
    <h6>- Mutation Magnitude: 0.25</h6>
    <h6>- Weight Clamping: only allow weights to be between -1 and 1 (weights are some of the parameters in a neural network)</h6>

    <h1>Exploration vs Exploitation</h1>
    <p>In reinforcement learning, there is a thing called explore-exploit dilemma. Explore refers to the bot constantly trying out new things in order to find a better strategy. Exploit refers to the bot relies on its current knowledge and do things that it knows is good for sure.</p>
    <p>In other word, this dilemma is about how much a bot should stay in its comfort zone.</p>
    <h2>Exploitation</h2>
    <p>
      In the evolution process, the best bots from the previous population will also be included in the current populations. This can ensure that there is enough exploitation. This technique is somewhat like increasing the life expectancy of an organism, where organism have more opportunity to pass down their genes.
    </p>
    <div class="centerAlign" style="margin-bottom: 40px">
    <div class="Slide frame">
      <div class="Arrows">
        <div class="lArrow" onclick="slideL()">&lt;</div>
        <div class="rArrow" onclick="slideR()">&gt;</div>
      </div>
      <div class="b4after">Before:</div>
      <img src="images/explore1.png" alt="normal exploration" class="explore1" />
      <img src="images/explore2.png" alt="exploration by extending life expectancy" class="explore2"/>
    </div>
  </div>
    <p>
      The best bots so far will also be included in the current population too. Since apparently the technique above still doesn't give enough exploitation. This technique can be thought of as the admiration for successful people in history, where we do not completely forget about previous successful people.
    </p>    
    <div class="centerAlign"><img src="images/explore3.png" alt="exploration by admiration" class="explore3 space frame" /></div>
    <h2>Exploration</h2>
    <p>
      The lasers on the wall aren't there originally, I added them because without them, the bots will all just go to a wall and do nothing, since the probability of dying when staying at a wall is smaller. In other words this technique is for reducing exploitation and increase exploration. (The gif below has been sped up 5x)
    </p>
    <div class="centerAlign"><img src="images/exploitation.gif" alt="exploitation by adding wall laser" class="exploit space frame"/></div>

    <h1>Mathematical Details of the Architecture</h1>
    
      <h2>Raw inputs from the environment: </h2>
    <h4>
      \(x_{raw}\) - x position of the bot, where \(-4.37 \le x_{raw} \le 4.37\) (game area width) <br /><br />
      \(y_{raw}\) - y position of the bot, where \(-8.25 \le y_{raw} \le 8.25\) (game area height) <br /><br />
      \(u_{raw}\) - x velocity of the bot, where \(-3 \le u_{raw} \le 3\) <br /><br />
      \(v_{raw}\) - y velocity of the bot, where \(-3 \le v_{raw} \le 3\) <br /><br />
      \(L_{raw}=(l_1,l_2,l_3,l_4...l_{12})\) - vector of the distances from the lasers detected, where each component corresponds to one of the laser detecting rays, the component is \(\infty\) if that detecting ray doesn't detect any laser <br /><br />
      \(T_{raw}=(t_1,t_2,t_3,t_4...t_{12})\) - vector of the urgency values of the lasers detected, the component is 1 if that detecting ray doesn't detect any laser<br /><br />
      \(c_{raw}=
      \begin{cases}
      1  & \text{if the bot is in a laser} \\
      0 & \text{if the bot is not in a laser}
      \end{cases}
      \)
    </h4>
    <h5>
      The above raw inputs are not used directly as the input of the neural network, they are all squeezed into processed inputs which are in the range of -1 to 1
    </h5>
   <br /> 
    <h2>
      Processed inputs: 
    </h2>
    <h4>
      \(x=tanh(\frac{x_{raw}}2)\) - processed x position <br /><br />
      \(y=tanh(\frac89y_{raw})\) - processed y position <br /><br />
      \(u=tanh(\frac43u_{raw})\) - processed x velocity <br /><br />
      \(v=tanh(\frac43v_{raw})\) - processed y velocity <br /><br />
      \(L=T\odot 0.85^{\frac{10}3L}\) where \(\odot\) denotes the hadamard product (elementwise product) and \(0.85^{\frac{10}3L}\) is an elementwise exponential function <br /><br />
      \(I_0=concat(L, x, y, u, v, c_{raw})\) where concat is a function that concatenate a bunch of vectors into one long vector. E.g. \(concat((1, 2), (3, 4))=(1,2,3,4)\)<br /><br />
      \(I=\)column matrix of \(I_0\)
    </h4>
      <h5>The constants in the equation above are all chosen only based on personal choice. E.g. In \(T\odot 0.85^{\frac{10}3L}\), the 0.85 is chosen by looking at the graph in desmos and see if it looks good.</h5>
      <h5>We can now use \(I\) as the input of the neural network </h5>
      <br />
      <h2>
        Neural Network Equations: 
      </h2>
    <h4>
      \(H=tanh(W_{ih}I+B_{ih})\) where \(W_{ih}\) is the weight matrix between input and hidden layer, \(B_{ih}\) is the bias matrix between input and hidden layer, \(tanh()\) is an elementwise hyperbolic tangent function<br /><br />
      \(O=sign(W_{ho}H+B_{ho})\) where \(W_{ho}\) is the weight matrix between hidden and output layer, \(B_{ho}\) is the bias matrix between hidden and output layer, \(sign()\) is an elementwise sign function<br /><br />
      The matrix \(O\) has 4 components each corresponds to one of the four arrow keys. <br /><br />
      Let \(O=
        \left[
        \begin{array}{}
        o_{left} \\ o_{right} \\ o_{up} \\ o_{down}
        \end{array}
        \right]
      \), <br /><br />

      Lastly, the bot presses \(
        \begin{cases}
        \text{left arrow} & \text{if }o_{left} \gt o_{right} \\
        \text{right arrow} & \text{if }o_{right} \gt o_{left} \\
        \text{nothing} & \text{if }o_{left} = o_{right}
        \end{cases}  
      \)
      and also presses \(
        \begin{cases}
        \text{up arrow} & \text{if }o_{up} \gt o_{down} \\
        \text{down arrow} & \text{if }o_{down} \gt o_{up} \\
        \text{nothing} & \text{if }o_{up} = o_{down}
        \end{cases}  
      \)
    </h4>
    <br />
      <div class="centerAlign"><img src="images/architecture.png" alt="the architecture used" class="architecture space" /></div>
    </p>
  </div>
  </body>
</html>
